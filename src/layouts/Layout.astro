---
import ChevronDown from '~/icons/chevron-down';
import Languages from '~/icons/languages';
import Monitor from '~/icons/monitor';
import Moon from '~/icons/moon';
import Sun from '~/icons/sun';
import '../styles/global.css'
import { t } from '../i18n';
import { useLocale } from '../i18n/context';
import LanguagePicker from '@/components/LanguagePicker.astro';
import { ClientRouter } from 'astro:transitions';

interface Props {
	title?: string;
	description?: string
	context?: string
}

const { context = 'landing'} = Astro.props
const lang = useLocale(Astro)
---
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewporðŸ‡ªðŸ‡¸t" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{t(lang, 'title')}</title>
		<meta name="description" content={t(lang, 'description')}>
		<meta name="author" content="Ignacio Sotelo" />
		<meta name="keywords" content="Portfolio, Developer, Software Engineer, Web Developer, Fullstack, Frontend, Backend, JavaScript, TypeScript, React, Node.js, Astro" />
		<ClientRouter />
		<script>
			const userPref = localStorage.getItem('theme-preference')
			const systemPref = window.matchMedia('(prefers-color-scheme: dark')
			
			// Usamos targetElement para en transiciones aplicar el tema al body del nuevo documento.
			const applyTheme = (theme: string, targetElement = document.body) => {
				
				targetElement.classList.remove('light', 'dark', 'system')
				if(theme === 'dark'){
					targetElement.classList.add('dark')
				} else if(theme === 'system') {
					if(systemPref.matches) {
						targetElement.classList.add('dark')
					} else {
						targetElement.classList.add('light')
					}
				} else {
					targetElement.classList.add('light')
				}
			}

			
			const attachPickers = () => {
				const themePicker = document.getElementById('themePicker');
				if(!themePicker) return
				const userPref = localStorage.getItem('theme-preference') || 'system'
				const allPickers = themePicker.querySelectorAll('[data-theme]')
				allPickers.forEach(picker => {
					if((picker as HTMLElement)?.dataset?.theme === userPref) {
						picker.setAttribute('aria-selected', 'true')
					} else {
						picker.removeAttribute('aria-selected')
					}
				})
				
				themePicker.addEventListener('click', (e) => {
					const picker = (e.target as HTMLElement)?.closest?.('[data-theme]') as HTMLElement | null
					if(!picker) return

					const theme = picker?.dataset?.theme
					if(!theme) return

					localStorage.setItem('theme-preference', theme)

					allPickers.forEach(p => p.removeAttribute('aria-selected'))
					picker.setAttribute('aria-selected', 'true')

					applyTheme(theme)
				})
			}
			
			applyTheme(userPref || 'system')
			attachPickers()
			
			// Asegurar que el tema se aplica en transiciones, porque ClientRouter reemplaza el HTML antes de aplicar las clases.
			document.addEventListener('astro:before-swap', (ev) => {
				const theme = localStorage.getItem('theme-preference') || 'system'
				applyTheme(theme, ev.newDocument.body)
			})

			document.addEventListener('astro:page-load', () => {
				attachPickers()
			})
		</script>
	</head>
	<body class={`text-typography-main ${context}`}>
		<header class="w-full h-16 fixed top-0 z-50 flex animate-header px-12">
			<nav class="flex items-center justify-between w-full h-full">
				<div>logo</div>
				<div class="flex items-center justify-between gap-x-3">
					<div class="relative group py-4">
						<button data-action="downloadCV" title="Descargar CV" class="cursor-pointer flex items-center gap-x-0.5 hover:text-typography-secondary" aria-label="Descargar CV">
							<span>
								Resume
							</span>
							<ChevronDown size={16} />
						</button>
						<div data-cv-dropdown class="absolute top-[calc(4rem_/_2_+_20px)] bg-surface-card border border-edge px-3 py-2 rounded-md group-hover:flex hidden flex-col gap-y-1 text-sm font-semibold">
							<a class="flex items-center gap-x-1 w-full hover:bg-surface-elevated px-2 py-1 rounded-sm" href="/CV_Ignacio_Sotelo_ES.pdf" download>
									<span>ES</span>
									<img class="size-5" src="/flags/es.svg" alt="">
								</a>
							<a class="flex items-center gap-x-1 w-full hover:bg-surface-elevated px-2 py-1 rounded-sm" href="/CV_Ignacio_Sotelo_EN.pdf" download>
									<span>EN</span>
									<img class="size-5" src="/flags/us.svg" alt="">
								</a>
						</div>
					</div>
					<div class="h-5 p-px bg-edge rounded-full" />
					<div class="relative group py-4">
						<button data-action="switchLang" id="changeLanguage" class="flex items-center gap-x-0.5 py-2 px-3 cursor-pointer hover:text-typography-secondary" aria-label="Cambiar idioma">
							<Languages size={20} />
							<ChevronDown size={16} />
						</button>
						<LanguagePicker />
					</div>
					<div class="h-5 p-px bg-edge rounded-full" />
					<div class="relative cursor-pointer py-4">
						<div id="themePicker" class="flex items-center p-0.5 bg-surface-elevated border border-edge rounded-full " aria-label="Cambiar tema">
							<span data-theme="system" class="p-1.5 rounded-full hover:bg-surface-card aria-selected:bg-surface-card" title={t(lang, 'theme.system')}>
								<Monitor size={20} />
							</span>
							<span data-theme="light" class="p-1.5 rounded-full hover:bg-surface-card aria-selected:bg-surface-card" title={t(lang, 'theme.light')}>
								<Sun size={20} />
							</span>
							<span data-theme="dark" class="p-1.5 rounded-full hover:bg-surface-card aria-selected:bg-surface-card" title={t(lang, 'theme.dark')}>
								<Moon size={20} />
							</span>
						</div>
					</div>
				</div>
			</nav>
		</header>
		<slot />
	</body>
</html>
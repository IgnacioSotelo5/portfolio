---
import LanguagePicker from './LanguagePicker.astro';
import ThemePicker from './ThemePicker.astro';
import ResumeDownloadDropdown from './ResumeDownloadDropdown.astro';
import ChartNoAxesGantt from '~/icons/chart-no-axes-gantt';
import X from '~/icons/x';
import { useLocale } from '@/i18n/context';

const lang = useLocale(Astro);
---

<header class="w-full h-16 fixed top-0 flex animate-header px-8 lg:px-12 z-50">
	<nav class="flex items-center justify-between w-full h-full">
		<a href={`${lang === 'es' ? '/es' : '/'}`} class="flex items-center h-full">
			<img src="/logo.webp" id="logo" alt="logo" class="h-16">
		</a>
		<div>
			<button class="flex items-center md:hidden pr-4" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobile-menu">
				<ChartNoAxesGantt id="menu-button" class='size-6 absolute transition-all duration-300 ease-in-out' />
				<X id="close-button" class='size-6 absolute opacity-0 transition-all duration-300 ease-in-out pointer-events-none' />
			</button>
			<div id="mobile-menu" class="opacity-0 bg-surface-card border-t border-edge md:border-0 md:bg-transparent flex-col items-start w-full h-screen absolute top-16 md:top-0 px-8 right-0 left-0 md:opacity-100 md:h-auto md:gap-x-3 md:flex md:flex-row md:relative md:justify-between md:items-center md:gap-y-0 gap-y-3 transition-all duration-300 ease-in-out">
				<ResumeDownloadDropdown />
				<div class="p-px w-full rounded-md bg-edge md:h-5 md:rounded-full" />
				<LanguagePicker />
				<div class="p-px w-full rounded-md bg-edge md:h-5 md:rounded-full" />
				<ThemePicker />
			</div>
		</div>
	</nav>
</header>

<script>
	let menuOpen = false;
	let menuButtonHandler: (() => void) | null = null;
	let closeButtonHandler: (() => void) | null = null;
	let keydownHandler: ((e: KeyboardEvent) => void) | null = null;

	function toggleMenu(open?: boolean) {
		const menuButton = document.querySelector('#menu-button');
		const closeButton = document.querySelector('#close-button');
		const menu = document.querySelector('#mobile-menu');
		const headerButton = document.querySelector('button[aria-controls="mobile-menu"]');
		
		if (!menu || !menuButton || !closeButton || !headerButton) return;
		
		menuOpen = open ?? !menuOpen;
		
		if (menuOpen) {
			menu?.classList.remove('menu-closed');
			menu?.classList.add('menu-open');
			menuButton?.classList.add('hidden');
			closeButton?.classList.add('visible');
			headerButton?.setAttribute('aria-expanded', 'true');
		} else {
			menu?.classList.remove('menu-open');
			menu?.classList.add('menu-closed');
			menuButton?.classList.remove('hidden');
			closeButton?.classList.remove('visible');
			headerButton?.setAttribute('aria-expanded', 'false');
		}

	}

	function initMenu() {
		const menuButton = document.querySelector('#menu-button');
		const closeButton = document.querySelector('#close-button');

		if (menuButtonHandler && menuButton) {
			menuButton.removeEventListener('click', menuButtonHandler);
		}
		if (closeButtonHandler && closeButton) {
			closeButton.removeEventListener('click', closeButtonHandler);
		}
		if (keydownHandler) {
			window.removeEventListener('keydown', keydownHandler);
		}

		menuButtonHandler = () => toggleMenu(true);
		closeButtonHandler = () => toggleMenu(false);
		keydownHandler = (e: KeyboardEvent) => {
			if (e.key === 'Escape' && menuOpen) toggleMenu(false);
		};

		menuButton?.addEventListener('click', menuButtonHandler);
		closeButton?.addEventListener('click', closeButtonHandler);
		window.addEventListener('keydown', keydownHandler);
	}

	document.addEventListener('astro:page-load', () => {
		initMenu()
		toggleMenu(false)
	})
</script>

<style>
	@media (width < 768px) {
		#mobile-menu {
			transform: translateY(-10px);
		}

		#mobile-menu.menu-open {
			display: flex;
			animation: fadeSlideDown 0.3s ease-in-out forwards;
		}

		#mobile-menu.menu-closed {
			display: none;
			animation: fadeSlideUp 0.3s ease-in-out forwards;
		}

		@keyframes fadeSlideDown {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}		
		}

		@keyframes fadeSlideUp {
			from {
				opacity: 1;
				transform: translateY(0);
			}
			to {
				opacity: 0;
				transform: translateY(-10px);
			}
		}

		#menu-button.hidden {
			pointer-events: none;
		}

		#close-button.visible {
			opacity: 1;
			pointer-events: auto;
		}

		@media (prefers-reduced-motion: reduce) {
			#mobile-menu,
			#menu-button,
			#close-button {
				@apply transition-none;
			}

			@keyframes fadeSlideDown {
				from { opacity: 1; transform: translateY(0); }
				to { opacity: 1; transform: translateY(0); }
			}

			@keyframes fadeSlideUp {
				from { opacity: 1; transform: translateY(0); }
				to { opacity: 1; transform: translateY(0); }
			}
		}
	}
</style>
